{% extends "base.html" %}

{% block title %}Manager Dashboard - {{ manager.name }}{% endblock %}
{% block header %}Manager Dashboard{% endblock %}

{% block extra_styles %}
<style>
    .manager-context {
        background: #e7f3ff;
        border-left: 4px solid #2196F3;
        padding: 12px 16px;
        margin-bottom: 20px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .manager-context strong {
        color: #1976D2;
        font-size: 15px;
    }

    .manager-context a {
        color: #667eea;
        text-decoration: none;
        font-size: 13px;
    }

    .manager-context a:hover {
        text-decoration: underline;
    }

    th.sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 25px;
    }

    th.sortable:hover {
        background: #e9ecef;
    }

    th.sortable::after {
        content: '↕';
        position: absolute;
        right: 8px;
        opacity: 0.3;
        font-size: 12px;
    }

    th.sortable.asc::after {
        content: '↑';
        opacity: 1;
    }

    th.sortable.desc::after {
        content: '↓';
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="manager-context">
    <div>
        <strong>Managing team for:</strong> {{ manager.name }} ({{ manager.user_id }})
        <span style="color: #666; margin-left: 12px;">{{ team_members|length }} direct reports</span>
    </div>
    <a href="/manager/switch">Switch Manager</a>
</div>

<div class="card">
    <h2>Import Feedback</h2>
    <p style="margin-bottom: 16px;">Upload CSV files that individuals have shared with you.</p>

    <div class="form-group">
        <input type="file" id="feedbackFile" accept=".csv" />
    </div>
    <button onclick="importFeedback()" class="btn">Import Feedback CSV</button>
    <div id="importStatus" style="margin-top: 12px;"></div>
</div>

<div class="card">
    <h2>Your Team</h2>

    {% if team_members|length == 0 %}
    <p style="color: #999;">No team members found. Make sure the orgchart has been imported correctly.</p>
    {% else %}
    <table>
        <thead>
            <tr>
                <th class="sortable" data-sort="name">Name</th>
                <th class="sortable" data-sort="job">Job Title</th>
                <th class="sortable" data-sort="feedback">Feedback Count</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for member in team_members %}
            <tr data-name="{{ member.name }}" data-job="{{ member.job_title }}" data-feedback="{{ member.feedback_count }}">
                <td><strong>{{ member.name }}</strong></td>
                <td>{{ member.job_title }}</td>
                <td>{{ member.feedback_count }} feedback(s)</td>
                <td>
                    <a href="/manager/report/{{ member.user_id }}" class="btn" style="padding: 6px 16px;">View Report</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function importFeedback() {
    const fileInput = document.getElementById('feedbackFile');
    const file = fileInput.files[0];

    if (!file) {
        alert('Please select a file');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    document.getElementById('importStatus').innerHTML = '<p>Importing...</p>';

    fetch('/manager/import', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('importStatus').innerHTML =
                `<div class="success-message">✓ Imported ${data.count} feedback entries</div>`;
            setTimeout(() => location.reload(), 2000);
        } else {
            document.getElementById('importStatus').innerHTML =
                `<div class="error-message">Error: ${data.error}</div>`;
        }
    })
    .catch(err => {
        document.getElementById('importStatus').innerHTML =
            `<div class="error-message">Error: ${err.message}</div>`;
    });
}

// Table sorting functionality
document.addEventListener('DOMContentLoaded', function() {
    const headers = document.querySelectorAll('th.sortable');
    let currentSort = { column: 'name', direction: 'asc' };

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const sortKey = this.getAttribute('data-sort');
            sortTable(sortKey);
        });
    });

    function sortTable(column) {
        const table = document.querySelector('table tbody');
        const rows = Array.from(table.querySelectorAll('tr'));

        // Toggle direction if same column, otherwise default to ascending
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }

        // Update header classes
        document.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });
        document.querySelector(`th[data-sort="${column}"]`).classList.add(currentSort.direction);

        // Sort rows
        rows.sort((a, b) => {
            let aVal = a.getAttribute(`data-${column}`);
            let bVal = b.getAttribute(`data-${column}`);

            // Convert to numbers for feedback count
            if (column === 'feedback') {
                aVal = parseInt(aVal);
                bVal = parseInt(bVal);
            }

            if (currentSort.direction === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        // Re-append rows in sorted order
        rows.forEach(row => table.appendChild(row));
    }

    // Set initial sort indicator
    document.querySelector('th[data-sort="name"]').classList.add('asc');
});
</script>
{% endblock %}
