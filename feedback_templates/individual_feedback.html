{% extends "base.html" %}

{% block title %}Individual Feedback{% endblock %}
{% block header %}Individual Feedback{% endblock %}

{% block extra_styles %}
<style>
    .tenet-selector {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
        margin-bottom: 20px;
        width: 100%;
    }

    @media (max-width: 768px) {
        .tenet-selector {
            grid-template-columns: 1fr !important;
        }
    }

    .tenet-item {
        border: 2px solid #ddd;
        border-radius: 4px;
        padding: 8px 10px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
    }

    .tenet-item:hover {
        border-color: #667eea;
        background: #f8f9ff;
    }

    .tenet-item.selected-strength {
        border-color: #28a745;
        background: #d4edda;
    }

    .tenet-item.selected-improvement {
        border-color: #dc3545;
        background: #f8d7da;
    }

    .tenet-name {
        font-weight: 600;
        margin-bottom: 2px;
        font-size: 13px;
    }

    .tenet-description {
        font-size: 11px;
        color: #666;
        line-height: 1.3;
    }

    .feedback-list {
        margin-top: 20px;
    }

    .feedback-item {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 6px;
        margin-bottom: 12px;
    }

    .feedback-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .feedback-item-name {
        font-weight: 600;
        font-size: 15px;
        color: #2c3e50;
    }

    .feedback-tenets {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 8px;
        font-size: 13px;
    }

    .tenet-group {
        padding: 8px;
        background: white;
        border-radius: 4px;
    }

    .tenet-group-title {
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .tenet-group.strengths .tenet-group-title {
        color: #28a745;
    }

    .tenet-group.improvements .tenet-group-title {
        color: #dc3545;
    }

    .tenet-list {
        list-style: none;
        padding: 0;
        margin: 4px 0 0 0;
    }

    .tenet-list li {
        padding: 2px 0 2px 16px;
        position: relative;
        color: #495057;
        line-height: 1.4;
    }

    .tenet-list.strengths li::before {
        content: '✓';
        position: absolute;
        left: 0;
        color: #28a745;
        font-weight: bold;
    }

    .tenet-list.improvements li::before {
        content: '▸';
        position: absolute;
        left: 0;
        color: #dc3545;
        font-weight: bold;
    }

    .manager-group {
        margin-bottom: 8px;
    }

    .manager-header {
        background: #e7f3ff;
        padding: 8px 12px;
        font-weight: 600;
        border-left: 4px solid #667eea;
        margin-top: 12px;
        margin-bottom: 4px;
    }

    .person-option {
        padding: 6px 12px;
        padding-left: 24px;
    }

    .custom-user-input {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }

    .save-indicator {
        display: inline-block;
        margin-left: 12px;
        color: #28a745;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .save-indicator.show {
        opacity: 1;
    }

    .feedback-checklist {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 12px 16px;
        margin-bottom: 16px;
        border-radius: 4px;
        color: #856404;
        font-size: 13px;
        transition: all 0.3s;
    }

    .feedback-checklist.complete {
        background: #d4edda;
        border-left-color: #28a745;
        color: #155724;
    }

    .feedback-checklist strong {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .feedback-checklist ul {
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .feedback-checklist li {
        margin: 4px 0;
        padding-left: 20px;
        position: relative;
    }

    .feedback-checklist li::before {
        content: '○';
        position: absolute;
        left: 0;
        color: #ffc107;
        font-weight: bold;
    }

    .feedback-checklist li.done::before {
        content: '✓';
        color: #28a745;
    }

    .feedback-checklist.complete li::before {
        content: '✓';
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Select Your Identity</h2>
    <div class="form-group">
        <label>Who are you?</label>
        <select id="userSelect" onchange="handleUserSelection()">
            <option value="">-- Select your name --</option>
            <option value="__CUSTOM__">[ Not in list - Enter custom ID ]</option>
            {% for person in all_people %}
            <option value="{{ person.user_id }}" {% if current_user and current_user.user_id == person.user_id %}selected{% endif %}>
                {{ person.name }} ({{ person.user_id }})
            </option>
            {% endfor %}
        </select>
    </div>

    <div id="customUserInput" class="custom-user-input" style="display: none;">
        <div class="form-group">
            <label>Your User ID</label>
            <input type="text" id="customUserId" placeholder="e.g., jdoe">
        </div>
        <div class="form-group">
            <label>Your Name (optional)</label>
            <input type="text" id="customUserName" placeholder="e.g., John Doe">
        </div>
        <div style="grid-column: 1 / -1;">
            <button onclick="setCustomUser()" class="btn">Confirm Identity</button>
        </div>
    </div>
</div>

{% if current_user %}
<div class="card">
    <h2>Provide Feedback</h2>
    <p style="margin-bottom: 20px;">
        Select a colleague to provide feedback on. Choose 3 tenet strengths and 2-3 tenets for improvement.
        <span class="save-indicator" id="saveIndicator">✓ Saved</span>
    </p>

    <div class="form-group">
        <label>Select Colleague</label>
        <select id="colleagueSelect" onchange="selectColleague()">
            <option value="">-- Select someone to give feedback to --</option>
            {% for manager_group in people_by_manager %}
            <optgroup label="{{ manager_group.manager_name }}">
                {% for person in manager_group.people %}
                {% if not current_user or person.user_id != current_user.user_id %}
                <option value="{{ person.user_id }}">{{ person.name }} - {{ person.job_title }}</option>
                {% endif %}
                {% endfor %}
            </optgroup>
            {% endfor %}
        </select>
    </div>

    <div id="feedbackForm" style="display: none;">
        <div id="feedbackChecklist" class="feedback-checklist">
            <strong id="checklistTitle">Feedback Progress:</strong>
            <ul>
                <li id="checkStrengths">Select 3 strengths (0/3)</li>
                <li id="checkImprovements">Select 2-3 improvements (0/3)</li>
            </ul>
        </div>

        <h3>Strengths (Select exactly 3)</h3>
        <div id="strengthsSelector" class="tenet-selector"></div>

        <div class="form-group">
            <label>Strengths - Additional Comments</label>
            <textarea id="strengthsText" placeholder="Explain why you selected these strengths..."></textarea>
        </div>

        <h3>Areas for Improvement (Select 2-3)</h3>
        <div id="improvementsSelector" class="tenet-selector"></div>

        <div class="form-group">
            <label>Improvements - Additional Comments</label>
            <textarea id="improvementsText" placeholder="Explain your suggestions for improvement..."></textarea>
        </div>

        <button onclick="cancelFeedback()" class="btn btn-secondary">Done - Select Another Colleague</button>
    </div>

    <div class="feedback-list">
        <h3>Your Submitted Feedback</h3>
        <div id="feedbackList">
            {% if existing_feedback|length == 0 %}
            <p style="color: #999;">No feedback submitted yet.</p>
            {% else %}
            {% for fb in existing_feedback %}
            <div class="feedback-item">
                <div>
                    <strong>
                        {% for person in all_people %}
                        {% if person.user_id == fb.to_user_id %}{{ person.name }}{% endif %}
                        {% endfor %}
                    </strong>
                    - {{ fb.strengths|length }} strengths, {{ fb.improvements|length }} improvements
                </div>
                <div>
                    <button onclick="editFeedback('{{ fb.to_user_id }}')" class="btn btn-secondary" style="padding: 6px 12px; margin-right: 8px;">Edit</button>
                    <button onclick="deleteFeedback('{{ fb.to_user_id }}')" class="btn btn-danger" style="padding: 6px 12px;">Delete</button>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>

    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
        <h3>Export Feedback</h3>
        <p style="margin-bottom: 12px;">When you're done providing feedback, export CSV files to share with managers.</p>
        <a href="/individual/export-list" class="btn">Export Feedback CSVs</a>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Force apply grid styles (workaround for CSS specificity issue)
const styleSheet = document.createElement('style');
styleSheet.textContent = `
    .tenet-selector {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
        margin-bottom: 20px !important;
        width: 100% !important;
    }
    @media (max-width: 768px) {
        .tenet-selector {
            grid-template-columns: 1fr !important;
        }
    }
`;
document.head.appendChild(styleSheet);

const tenets = {{ tenets | tojson | safe }};
const allPeople = {{ all_people | tojson | safe }};
const existingFeedback = {{ existing_feedback | tojson | safe }};

let selectedColleague = null;
let selectedStrengths = [];
let selectedImprovements = [];
let autoSaveTimer = null;

function handleUserSelection() {
    const select = document.getElementById('userSelect');
    const value = select.value;

    if (value === '__CUSTOM__') {
        document.getElementById('customUserInput').style.display = 'grid';
    } else if (value) {
        document.getElementById('customUserInput').style.display = 'none';
        setUser(value);
    } else {
        document.getElementById('customUserInput').style.display = 'none';
    }
}

function setCustomUser() {
    const userId = document.getElementById('customUserId').value.trim();
    const userName = document.getElementById('customUserName').value.trim();

    if (!userId) {
        alert('Please enter a User ID');
        return;
    }

    setUser(userId);
}

function setUser(userId) {
    fetch('/api/set-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: userId})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function renderTenets() {
    const strengthsDiv = document.getElementById('strengthsSelector');
    const improvementsDiv = document.getElementById('improvementsSelector');

    strengthsDiv.innerHTML = '';
    improvementsDiv.innerHTML = '';

    tenets.forEach(tenet => {
        // Strength selector
        const strengthItem = document.createElement('div');
        strengthItem.className = 'tenet-item';
        if (selectedStrengths.includes(tenet.id)) {
            strengthItem.classList.add('selected-strength');
        }
        strengthItem.innerHTML = `
            <div class="tenet-name">${tenet.name}</div>
            <div class="tenet-description">${tenet.description}</div>
        `;
        strengthItem.onclick = () => toggleStrength(tenet.id);
        strengthsDiv.appendChild(strengthItem);

        // Improvement selector
        const improvementItem = document.createElement('div');
        improvementItem.className = 'tenet-item';
        if (selectedImprovements.includes(tenet.id)) {
            improvementItem.classList.add('selected-improvement');
        }
        improvementItem.innerHTML = `
            <div class="tenet-name">${tenet.name}</div>
            <div class="tenet-description">${tenet.description}</div>
        `;
        improvementItem.onclick = () => toggleImprovement(tenet.id);
        improvementsDiv.appendChild(improvementItem);
    });
}

function toggleStrength(tenetId) {
    const index = selectedStrengths.indexOf(tenetId);
    if (index > -1) {
        selectedStrengths.splice(index, 1);
    } else {
        if (selectedStrengths.length < 3) {
            selectedStrengths.push(tenetId);
        } else {
            // Don't show alert, just don't add it
            return;
        }
    }
    renderTenets();
    validateFeedback(); // Update inline errors
    scheduleAutoSave();
}

function toggleImprovement(tenetId) {
    const index = selectedImprovements.indexOf(tenetId);
    if (index > -1) {
        selectedImprovements.splice(index, 1);
    } else {
        if (selectedImprovements.length < 3) {
            selectedImprovements.push(tenetId);
        } else {
            // Don't show alert, just don't add it
            return;
        }
    }
    renderTenets();
    validateFeedback(); // Update inline errors
    scheduleAutoSave();
}

function selectColleague() {
    const userId = document.getElementById('colleagueSelect').value;
    if (!userId) {
        document.getElementById('feedbackForm').style.display = 'none';
        return;
    }

    selectedColleague = userId;

    // Load existing feedback if any
    const existing = existingFeedback.find(f => f.to_user_id === userId);
    if (existing) {
        selectedStrengths = existing.strengths;
        selectedImprovements = existing.improvements;
        document.getElementById('strengthsText').value = existing.strengths_text || '';
        document.getElementById('improvementsText').value = existing.improvements_text || '';
    } else {
        selectedStrengths = [];
        selectedImprovements = [];
        document.getElementById('strengthsText').value = '';
        document.getElementById('improvementsText').value = '';
    }

    renderTenets();
    updateChecklist(); // Initialize checklist
    document.getElementById('feedbackForm').style.display = 'block';

    // Add auto-save listeners to textareas
    document.getElementById('strengthsText').addEventListener('input', scheduleAutoSave);
    document.getElementById('improvementsText').addEventListener('input', scheduleAutoSave);
}

function scheduleAutoSave() {
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }

    autoSaveTimer = setTimeout(() => {
        saveFeedback();
    }, 2000);
}

function saveFeedback() {
    if (!selectedColleague) {
        return;
    }

    // Only save if we have valid selections
    if (selectedStrengths.length !== 3) {
        return;
    }

    if (selectedImprovements.length < 2 || selectedImprovements.length > 3) {
        return;
    }

    const data = {
        to_user_id: selectedColleague,
        strengths: selectedStrengths,
        improvements: selectedImprovements,
        strengths_text: document.getElementById('strengthsText').value,
        improvements_text: document.getElementById('improvementsText').value
    };

    fetch('/api/feedback', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showSaveIndicator();
            updateFeedbackList();
        }
    })
    .catch(err => {
        console.error('Auto-save error:', err);
    });
}

function updateFeedbackList() {
    // Update the existing feedback entry in the list without full page reload
    const existing = existingFeedback.find(f => f.to_user_id === selectedColleague);

    if (existing) {
        // Update existing entry
        existing.strengths = selectedStrengths;
        existing.improvements = selectedImprovements;
        existing.strengths_text = document.getElementById('strengthsText').value;
        existing.improvements_text = document.getElementById('improvementsText').value;
    } else {
        // Add new entry
        existingFeedback.push({
            to_user_id: selectedColleague,
            strengths: selectedStrengths,
            improvements: selectedImprovements,
            strengths_text: document.getElementById('strengthsText').value,
            improvements_text: document.getElementById('improvementsText').value
        });
    }

    renderFeedbackList();
}

function renderFeedbackList() {
    const listDiv = document.getElementById('feedbackList');

    if (existingFeedback.length === 0) {
        listDiv.innerHTML = '<p style="color: #999;">No feedback submitted yet.</p>';
        return;
    }

    listDiv.innerHTML = existingFeedback.map(fb => {
        const person = allPeople.find(p => p.user_id === fb.to_user_id);
        const personName = person ? person.name : fb.to_user_id;

        // Get tenet names
        const strengthTenets = fb.strengths.map(id => {
            const tenet = tenets.find(t => t.id === id);
            return tenet ? tenet.name : id;
        });

        const improvementTenets = fb.improvements.map(id => {
            const tenet = tenets.find(t => t.id === id);
            return tenet ? tenet.name : id;
        });

        return `
            <div class="feedback-item">
                <div class="feedback-item-header">
                    <div class="feedback-item-name">${personName}</div>
                    <div>
                        <button onclick="editFeedback('${fb.to_user_id}')" class="btn btn-secondary" style="padding: 6px 12px; margin-right: 8px;">Edit</button>
                        <button onclick="deleteFeedback('${fb.to_user_id}')" class="btn btn-danger" style="padding: 6px 12px;">Delete</button>
                    </div>
                </div>
                <div class="feedback-tenets">
                    <div class="tenet-group strengths">
                        <div class="tenet-group-title">Strengths (${fb.strengths.length})</div>
                        <ul class="tenet-list strengths">
                            ${strengthTenets.map(name => `<li>${name}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="tenet-group improvements">
                        <div class="tenet-group-title">Improvements (${fb.improvements.length})</div>
                        <ul class="tenet-list improvements">
                            ${improvementTenets.map(name => `<li>${name}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function showSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

function updateChecklist() {
    const strengthsDone = selectedStrengths.length === 3;
    const improvementsDone = selectedImprovements.length >= 2 && selectedImprovements.length <= 3;
    const allDone = strengthsDone && improvementsDone;

    // Update strengths checklist item
    const strengthsItem = document.getElementById('checkStrengths');
    strengthsItem.textContent = `Select 3 strengths (${selectedStrengths.length}/3)`;
    if (strengthsDone) {
        strengthsItem.classList.add('done');
    } else {
        strengthsItem.classList.remove('done');
    }

    // Update improvements checklist item
    const improvementsItem = document.getElementById('checkImprovements');
    if (selectedImprovements.length > 3) {
        improvementsItem.textContent = `Select 2-3 improvements (${selectedImprovements.length}/3 - deselect ${selectedImprovements.length - 3})`;
        improvementsItem.classList.remove('done');
    } else {
        improvementsItem.textContent = `Select 2-3 improvements (${selectedImprovements.length}/3)`;
        if (improvementsDone) {
            improvementsItem.classList.add('done');
        } else {
            improvementsItem.classList.remove('done');
        }
    }

    // Update checklist box color
    const checklistBox = document.getElementById('feedbackChecklist');
    const checklistTitle = document.getElementById('checklistTitle');

    if (allDone) {
        checklistBox.classList.add('complete');
        checklistTitle.textContent = '✓ Ready to save (auto-saves in 2 seconds)';
    } else {
        checklistBox.classList.remove('complete');
        checklistTitle.textContent = 'Feedback Progress:';
    }

    return allDone;
}

function validateFeedback() {
    return updateChecklist();
}

function cancelFeedback() {
    // Check if there's any data entered
    const hasAnyData = selectedStrengths.length > 0 ||
                       selectedImprovements.length > 0 ||
                       document.getElementById('strengthsText').value.trim() !== '' ||
                       document.getElementById('improvementsText').value.trim() !== '';

    // If there's data, validate it
    if (hasAnyData) {
        const isValid = updateChecklist();
        if (!isValid) {
            // Keep form open, checklist shows what's missing
            return;
        }
    }

    // Either no data or valid - close the form
    document.getElementById('colleagueSelect').value = '';
    document.getElementById('feedbackForm').style.display = 'none';
    selectedColleague = null;
    selectedStrengths = [];
    selectedImprovements = [];

    // Scroll to top of feedback list
    document.querySelector('.feedback-list').scrollIntoView({ behavior: 'smooth' });
}

function editFeedback(userId) {
    document.getElementById('colleagueSelect').value = userId;
    selectColleague();
}

function deleteFeedback(userId) {
    if (!confirm('Are you sure you want to delete this feedback?')) {
        return;
    }

    fetch(`/api/feedback/${userId}`, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Remove from local array
            const index = existingFeedback.findIndex(f => f.to_user_id === userId);
            if (index > -1) {
                existingFeedback.splice(index, 1);
            }
            renderFeedbackList();
        }
    });
}

// Initialize feedback list rendering on page load
if (existingFeedback.length > 0) {
    renderFeedbackList();
}
</script>
{% endblock %}
