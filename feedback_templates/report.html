{% extends "base.html" %}

{% block title %}Feedback Report - {{ team_member.name }}{% endblock %}
{% block header %}Feedback Report{% endblock %}

{% block extra_styles %}
<style>
    .tenet-selector {
        display: grid;
        gap: 8px;
        margin-bottom: 20px;
    }

    .tenet-item {
        border: 2px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .tenet-item:hover {
        border-color: #667eea;
        background: #f8f9ff;
    }

    .tenet-item.selected-strength {
        border-color: #28a745;
        background: #d4edda;
    }

    .tenet-item.selected-improvement {
        border-color: #dc3545;
        background: #f8d7da;
    }

    .tenet-name {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .tenet-description {
        font-size: 12px;
        color: #666;
    }

    .feedback-text-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
    }

    .save-indicator {
        display: inline-block;
        margin-left: 12px;
        color: #28a745;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .save-indicator.show {
        opacity: 1;
    }

    .manager-context {
        background: #e7f3ff;
        border-left: 4px solid #2196F3;
        padding: 12px 16px;
        margin-bottom: 20px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .manager-context strong {
        color: #1976D2;
        font-size: 15px;
    }

    .manager-context a {
        color: #667eea;
        text-decoration: none;
        font-size: 13px;
    }

    .manager-context a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="manager-context">
    <div>
        <strong>Viewing report as:</strong> {{ team_member.name }}
    </div>
    <a href="/manager">← Back to Dashboard</a>
</div>

<div class="card">

    <h2>{{ team_member.name }}</h2>
    <p style="color: #666; margin-bottom: 20px;">
        {{ team_member.job_title }} | {{ team_member.email }}
    </p>

    <div class="info-box">
        <strong>{{ feedbacks|length }} peer feedback(s) received</strong>
    </div>
</div>

<div class="card">
    <h2>Team Tenets - Butterfly Chart</h2>
    <p style="margin-bottom: 12px; color: #666;">
        Aggregated feedback from all peers. Strengths shown in green (right), improvements in red (left).
    </p>
    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px 14px; margin-bottom: 20px; border-radius: 4px; font-size: 13px;">
        <strong>Legend:</strong> Highlighted tenets (brighter color, thicker border) were selected by your manager.
        Bar lengths include both peer feedback AND manager selection (each counts as +1).
    </div>
    <div id="butterflyChart"></div>
</div>

<div class="card">
    <h2>Peer Feedback Comments</h2>

    <h3>Strengths</h3>
    {% if feedbacks|length == 0 %}
    <p style="color: #999;">No feedback received yet.</p>
    {% else %}
    {% for fb in feedbacks %}
    {% if fb.strengths_text %}
    <div class="feedback-text-item">
        {{ fb.strengths_text }}
    </div>
    {% endif %}
    {% endfor %}
    {% endif %}

    <h3 style="margin-top: 24px;">Areas for Improvement</h3>
    {% for fb in feedbacks %}
    {% if fb.improvements_text %}
    <div class="feedback-text-item">
        {{ fb.improvements_text }}
    </div>
    {% endif %}
    {% endfor %}
</div>

<div class="card">
    <h2>Your Feedback (Manager)</h2>
    <p style="margin-bottom: 16px; color: #666;">
        Select tenets to highlight in the report and add your own feedback text.
    </p>

    <h3>Select Strengths to Highlight</h3>
    <div id="managerStrengthsSelector" class="tenet-selector"></div>

    <h3>Select Improvements to Highlight</h3>
    <div id="managerImprovementsSelector" class="tenet-selector"></div>

    <div class="form-group">
        <label>Your Feedback Text</label>
        <textarea id="managerFeedbackText" placeholder="Write your feedback for this team member...">{{ manager_feedback.feedback_text if manager_feedback else '' }}</textarea>
        <span id="saveIndicator" class="save-indicator">✓ Saved</span>
    </div>
</div>

<div class="card">
    <h2>Export Report</h2>
    <p style="margin-bottom: 16px;">
        Generate a PDF report with the butterfly chart and all feedback (peer feedback anonymous, your feedback attributed).
    </p>
    <button onclick="exportPDF()" class="btn">Export PDF Report (Coming Soon)</button>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Force apply two-column grid layout (CSS injection workaround)
const styleSheet = document.createElement('style');
styleSheet.textContent = `
    .tenet-selector {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
        margin-bottom: 20px !important;
        width: 100% !important;
    }
`;
document.head.appendChild(styleSheet);

const butterflyData = {{ butterfly_data | tojson | safe }};
const tenets = {{ tenets | tojson | safe }};
const teamMemberId = "{{ team_member.user_id }}";

let managerSelectedStrengths = {{ (manager_feedback.selected_strengths if manager_feedback else []) | tojson | safe }};
let managerSelectedImprovements = {{ (manager_feedback.selected_improvements if manager_feedback else []) | tojson | safe }};

// Auto-save state
let autoSaveTimer = null;

// Render butterfly chart
function renderButterflyChart() {
    const container = document.getElementById('butterflyChart');
    container.innerHTML = '';

    // Check if we have data
    if (!butterflyData || butterflyData.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No feedback data available yet.</p>';
        return;
    }

    // Calculate max value, ensure minimum of 1 for proper scaling
    const maxValue = Math.max(
        1,  // Minimum value to prevent chart issues
        ...butterflyData.map(t => Math.max(t.strength_count, t.improvement_count))
    );

    butterflyData.forEach((tenet, index) => {
        const row = document.createElement('div');
        row.style.cssText = 'display: grid; grid-template-columns: 1fr 300px 1fr; gap: 8px; align-items: center; margin-bottom: 4px; padding: 2px 0;';

        // Left - Improvements (red)
        const improvementDiv = document.createElement('div');
        improvementDiv.style.cssText = 'text-align: right;';
        const improvementCanvas = document.createElement('canvas');
        improvementCanvas.id = `improvement-${index}`;
        improvementCanvas.height = 25;
        improvementDiv.appendChild(improvementCanvas);

        // Center - Tenet name
        const labelDiv = document.createElement('div');
        labelDiv.style.cssText = 'font-weight: 600; color: #2c3e50; padding: 0 10px; text-align: center; overflow: hidden; text-overflow: ellipsis; font-size: 14px;';

        // Highlight if manager selected
        const isStrengthSelected = managerSelectedStrengths.includes(tenet.id);
        const isImprovementSelected = managerSelectedImprovements.includes(tenet.id);

        if (isStrengthSelected || isImprovementSelected) {
            labelDiv.style.cssText += ' background: #fff3cd; border: 2px solid #ffc107; border-radius: 4px; padding: 4px 10px;';
        }

        labelDiv.textContent = tenet.name;

        // Right - Strengths (green)
        const strengthDiv = document.createElement('div');
        strengthDiv.style.cssText = 'text-align: left;';
        const strengthCanvas = document.createElement('canvas');
        strengthCanvas.id = `strength-${index}`;
        strengthCanvas.height = 25;
        strengthDiv.appendChild(strengthCanvas);

        row.appendChild(improvementDiv);
        row.appendChild(labelDiv);
        row.appendChild(strengthDiv);
        container.appendChild(row);

        // Create charts
        new Chart(improvementCanvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [{
                    data: [tenet.improvement_count],
                    backgroundColor: isImprovementSelected ? '#ff6b6b' : '#dc3545',
                    borderColor: isImprovementSelected ? '#ff0000' : '#c82333',
                    borderWidth: isImprovementSelected ? 3 : 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Improvements: ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: maxValue,
                        reverse: true,
                        display: false,
                        grid: { display: false },
                        ticks: { display: false }
                    },
                    y: {
                        display: false,
                        grid: { display: false }
                    }
                }
            }
        });

        new Chart(strengthCanvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [{
                    data: [tenet.strength_count],
                    backgroundColor: isStrengthSelected ? '#51cf66' : '#28a745',
                    borderColor: isStrengthSelected ? '#00ff00' : '#1e7e34',
                    borderWidth: isStrengthSelected ? 3 : 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Strengths: ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: maxValue,
                        display: false,
                        grid: { display: false },
                        ticks: { display: false }
                    },
                    y: {
                        display: false,
                        grid: { display: false }
                    }
                }
            }
        });
    });
}

// Render manager tenet selectors
function renderManagerTenetSelectors() {
    const strengthsDiv = document.getElementById('managerStrengthsSelector');
    const improvementsDiv = document.getElementById('managerImprovementsSelector');

    strengthsDiv.innerHTML = '';
    improvementsDiv.innerHTML = '';

    tenets.forEach(tenet => {
        // Strength selector
        const strengthItem = document.createElement('div');
        strengthItem.className = 'tenet-item';
        if (managerSelectedStrengths.includes(tenet.id)) {
            strengthItem.classList.add('selected-strength');
        }
        strengthItem.innerHTML = `
            <div class="tenet-name">${tenet.name}</div>
            <div class="tenet-description" style="font-size: 12px; color: #666;">${tenet.description}</div>
        `;
        strengthItem.onclick = () => toggleManagerStrength(tenet.id);
        strengthsDiv.appendChild(strengthItem);

        // Improvement selector
        const improvementItem = document.createElement('div');
        improvementItem.className = 'tenet-item';
        if (managerSelectedImprovements.includes(tenet.id)) {
            improvementItem.classList.add('selected-improvement');
        }
        improvementItem.innerHTML = `
            <div class="tenet-name">${tenet.name}</div>
            <div class="tenet-description" style="font-size: 12px; color: #666;">${tenet.description}</div>
        `;
        improvementItem.onclick = () => toggleManagerImprovement(tenet.id);
        improvementsDiv.appendChild(improvementItem);
    });
}

function toggleManagerStrength(tenetId) {
    const index = managerSelectedStrengths.indexOf(tenetId);
    if (index > -1) {
        managerSelectedStrengths.splice(index, 1);
    } else {
        managerSelectedStrengths.push(tenetId);
    }
    renderManagerTenetSelectors();
    renderButterflyChart();
    scheduleAutoSave();
}

function toggleManagerImprovement(tenetId) {
    const index = managerSelectedImprovements.indexOf(tenetId);
    if (index > -1) {
        managerSelectedImprovements.splice(index, 1);
    } else {
        managerSelectedImprovements.push(tenetId);
    }
    renderManagerTenetSelectors();
    renderButterflyChart();
    scheduleAutoSave();
}

function scheduleAutoSave() {
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    autoSaveTimer = setTimeout(() => {
        saveManagerFeedback();
    }, 2000);
}

function showSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

function saveManagerFeedback() {
    const data = {
        team_member_uid: teamMemberId,
        selected_strengths: managerSelectedStrengths,
        selected_improvements: managerSelectedImprovements,
        feedback_text: document.getElementById('managerFeedbackText').value
    };

    fetch('/api/manager-feedback', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showSaveIndicator();
        } else {
            console.error('Error saving manager feedback:', data.error);
        }
    })
    .catch(error => {
        console.error('Error saving manager feedback:', error);
    });
}

function exportPDF() {
    alert('PDF export will be implemented next. For now, you can use your browser\'s Print to PDF feature.');
}

// Initialize
try {
    console.log('Butterfly data:', butterflyData);
    console.log('Tenets:', tenets);
    renderButterflyChart();
    renderManagerTenetSelectors();
} catch (error) {
    console.error('Error initializing charts:', error);
    document.getElementById('butterflyChart').innerHTML =
        '<p style="color: #dc3545; padding: 20px;">Error loading chart: ' + error.message + '</p>';
}

// Add auto-save to feedback text
const feedbackTextArea = document.getElementById('managerFeedbackText');
feedbackTextArea.addEventListener('input', () => {
    scheduleAutoSave();
});
</script>
{% endblock %}
