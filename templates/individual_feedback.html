{% extends "base.html" %}

{% block title %}Individual Feedback{% endblock %}
{% block header %}Individual Feedback{% endblock %}

{% block extra_styles %}
<style>
    .feedback-list {
        margin-top: 20px;
    }

    .feedback-item {
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 12px;
        overflow: hidden;
    }

    .feedback-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
    }

    .feedback-item-header:hover {
        background: #e9ecef;
    }

    .feedback-item-name {
        font-weight: 600;
        font-size: 15px;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .feedback-item-name::before {
        content: 'â–¶';
        font-size: 10px;
        color: #999;
        transition: transform 0.2s;
    }

    .feedback-item.expanded .feedback-item-name::before {
        transform: rotate(90deg);
    }

    .feedback-item-summary {
        font-size: 13px;
        color: #666;
        margin-left: 8px;
        font-weight: normal;
    }

    .feedback-item-actions {
        display: flex;
        gap: 8px;
    }

    .feedback-item-body {
        display: none;
        padding: 0 16px 16px 16px;
        border-top: 1px solid #e9ecef;
    }

    .feedback-item.expanded .feedback-item-body {
        display: block;
    }

    .feedback-tenets {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 8px;
        font-size: 13px;
    }

    .tenet-group {
        padding: 8px;
        background: white;
        border-radius: 4px;
    }

    .tenet-group-title {
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .tenet-group.strengths .tenet-group-title {
        color: #28a745;
    }

    .tenet-group.improvements .tenet-group-title {
        color: #dc3545;
    }

    .tenet-list {
        list-style: none;
        padding: 0;
        margin: 4px 0 0 0;
    }

    .tenet-list li {
        padding: 2px 0 2px 16px;
        position: relative;
        color: #495057;
        line-height: 1.4;
    }

    .tenet-list.strengths li::before {
        content: 'âœ“';
        position: absolute;
        left: 0;
        color: #28a745;
        font-weight: bold;
    }

    .tenet-list.improvements li::before {
        content: 'â–¸';
        position: absolute;
        left: 0;
        color: #dc3545;
        font-weight: bold;
    }

    .manager-group {
        margin-bottom: 8px;
    }

    .manager-header {
        background: #e7f3ff;
        padding: 8px 12px;
        font-weight: 600;
        border-left: 4px solid #667eea;
        margin-top: 12px;
        margin-bottom: 4px;
    }

    .person-option {
        padding: 6px 12px;
        padding-left: 24px;
    }

    .save-indicator {
        display: inline-block;
        margin-left: 12px;
        color: #28a745;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .save-indicator.show {
        opacity: 1;
    }

    .feedback-checklist {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 12px 16px;
        margin-bottom: 16px;
        border-radius: 4px;
        color: #856404;
        font-size: 13px;
        transition: all 0.3s;
    }

    .feedback-checklist.complete {
        background: #d4edda;
        border-left-color: #28a745;
        color: #155724;
    }

    .feedback-checklist strong {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .feedback-checklist ul {
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .feedback-checklist li {
        margin: 4px 0;
        padding-left: 20px;
        position: relative;
    }

    .feedback-checklist li::before {
        content: 'â—‹';
        position: absolute;
        left: 0;
        color: #ffc107;
        font-weight: bold;
    }

    .feedback-checklist li.done::before {
        content: 'âœ“';
        color: #28a745;
    }

    .feedback-checklist.complete li::before {
        content: 'âœ“';
        color: #28a745;
    }

    .user-context {
        background: #e7f3ff;
        border-left: 4px solid #2196F3;
        padding: 12px 16px;
        margin-bottom: 20px;
        border-radius: 4px;
        font-size: 14px;
    }

    .user-context strong {
        color: #1976D2;
    }
</style>
{% endblock %}

{% block content %}
<div class="user-context">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <strong>Providing feedback as:</strong>
            {% if current_user.name %}
                {{ current_user.name }} ({{ current_user.user_id }})
            {% else %}
                {{ current_user.user_id }}
            {% endif %}
        </div>
        <a href="/individual/switch" style="color: #667eea; text-decoration: none; font-size: 13px;">Switch User</a>
    </div>
</div>

{% if all_people|length <= 1 %}
<!-- No colleagues to give feedback to - show import option -->
<div class="card content-centered">
    <h2>Import Orgchart to Get Started</h2>
    <p style="margin-bottom: 20px; color: #666;">
        There are no colleagues in the database to provide feedback for. Import your team's orgchart to continue.
    </p>

    <div class="drop-zone" id="dropZone" style="border: 2px dashed #ccc; border-radius: 8px; padding: 30px 20px; text-align: center; background: #fafafa; cursor: pointer;">
        <div style="font-size: 36px; color: #999; margin-bottom: 8px;">+</div>
        <div style="color: #666; font-size: 14px;">Drag & drop orgchart CSV here, or click to browse</div>
        <input type="file" id="orgchartFile" accept=".csv" style="display: none;" />
    </div>

    <div id="importStatus"></div>

    <details style="margin-top: 16px; font-size: 13px;">
        <summary style="cursor: pointer; color: #667eea;">CSV Format Reference</summary>
        <pre style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-top: 12px; font-size: 12px; overflow-x: auto;">Name,User ID,Job Title,Location,Email,Manager UID
Della Gate,dgate,Engineering Manager,Raleigh NC,dgate@example.com,
Paige Duty,pduty,Staff SRE,Remote US,pduty@example.com,dgate</pre>
    </details>

    <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #eee;">
        <p style="color: #666; margin-bottom: 12px;">Or use a different workflow:</p>
        <a href="/feedback" class="btn btn-secondary" style="margin-right: 8px;">Quick Feedback (no orgchart)</a>
        <a href="/" class="btn btn-secondary">Back to Home</a>
    </div>
</div>
{% else %}
<!-- Normal state - show feedback form -->
<div class="card content-centered">
    <h2>Provide Feedback</h2>
    <p style="margin-bottom: 20px;">
        Select a colleague to provide feedback on. Choose 3 tenet strengths and 2-3 tenets for improvement.
        <span class="save-indicator" id="saveIndicator">âœ“ Saved</span>
    </p>

    <div class="form-group">
        <label>Select Colleague <span style="color: #666; font-weight: normal; font-size: 12px;">(âœ“ feedback provided, â—‹ pending)</span></label>
        <select id="colleagueSelect" onchange="selectColleague()">
            <option value="">-- Select someone to give feedback to --</option>
            {% for manager_group in people_by_manager %}
            <optgroup label="{{ manager_group.manager_name }}">
                {% for person in manager_group.people %}
                {% if not current_user or person.user_id != current_user.user_id %}
                {% set has_feedback = existing_feedback|selectattr('to_user_id', 'equalto', person.user_id)|list|length > 0 %}
                <option value="{{ person.user_id }}">{% if has_feedback %}âœ“{% else %}â—‹{% endif %} {{ person.name }} - {{ person.job_title }}</option>
                {% endif %}
                {% endfor %}
            </optgroup>
            {% endfor %}
        </select>
    </div>

    <div id="feedbackForm" style="display: none;">
        <div id="feedbackChecklist" class="feedback-checklist">
            <strong id="checklistTitle">Feedback Progress:</strong>
            <ul>
                <li id="checkStrengths">Select 3 strengths (0/3)</li>
                <li id="checkImprovements">Select 2-3 improvements (0/3)</li>
            </ul>
        </div>

        <h3>Strengths (Select exactly 3)</h3>
        <div id="strengthsSelector" class="tenet-selector"></div>

        <div class="form-group">
            <label>Strengths - Comments <span style="color: #666; font-weight: normal; font-size: 12px;">(optional but encouraged)</span></label>
            <textarea id="strengthsText" placeholder="Share specific examples or context for your selections..."></textarea>
        </div>

        <h3>Areas for Improvement (Select 2-3)</h3>
        <div id="improvementsSelector" class="tenet-selector"></div>

        <div class="form-group">
            <label>Improvements - Comments <span style="color: #666; font-weight: normal; font-size: 12px;">(optional but encouraged)</span></label>
            <textarea id="improvementsText" placeholder="Share specific examples or suggestions for growth..."></textarea>
        </div>

        <button onclick="cancelFeedback()" class="btn btn-secondary">Done - Select Another Colleague</button>
    </div>

    <div class="feedback-list">
        <h3>Your Submitted Feedback</h3>
        <div id="feedbackList">
            {% if existing_feedback|length == 0 %}
            <p style="color: #999;">No feedback submitted yet.</p>
            {% else %}
            {% for fb in existing_feedback %}
            <div class="feedback-item">
                <div>
                    <strong>
                        {% for person in all_people %}
                        {% if person.user_id == fb.to_user_id %}{{ person.name }}{% endif %}
                        {% endfor %}
                    </strong>
                    - {{ fb.strengths|length }} strengths, {{ fb.improvements|length }} improvements
                </div>
                <div>
                    <button onclick="editFeedback('{{ fb.to_user_id }}')" class="btn btn-secondary" style="padding: 6px 12px; margin-right: 8px;">Edit</button>
                    <button onclick="deleteFeedback('{{ fb.to_user_id }}')" class="btn btn-danger" style="padding: 6px 12px;">Delete</button>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>

</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Orgchart import (empty state)
const dropZone = document.getElementById('dropZone');
if (dropZone) {
    const fileInput = document.getElementById('orgchartFile');
    const statusDiv = document.getElementById('importStatus');

    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleImportFile(e.target.files[0]);
        }
        fileInput.value = '';
    });

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#667eea';
        dropZone.style.background = '#e8efff';
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ccc';
        dropZone.style.background = '#fafafa';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ccc';
        dropZone.style.background = '#fafafa';
        const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv'));
        if (files.length > 0) {
            handleImportFile(files[0]);
        }
    });

    function handleImportFile(file) {
        statusDiv.innerHTML = '<p>Importing...</p>';

        const formData = new FormData();
        formData.append('file', file);
        formData.append('reset', 'false');

        fetch('/api/import-orgchart', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = `<div style="background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-top: 12px;">Imported ${data.new_count} people. Reloading...</div>`;
                setTimeout(() => window.location.reload(), 1000);
            } else {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-top: 12px;">Error: ${data.error}</div>`;
            }
        })
        .catch(err => {
            statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-top: 12px;">Error: ${err.message}</div>`;
        });
    }
}

const tenets = {{ tenets | tojson | safe }};
const allPeople = {{ all_people | tojson | safe }};
const existingFeedback = {{ existing_feedback | tojson | safe }};

let selectedColleague = null;
let selectedStrengths = [];
let selectedImprovements = [];
let autoSaveTimer = null;

function renderTenets() {
    const strengthsDiv = document.getElementById('strengthsSelector');
    const improvementsDiv = document.getElementById('improvementsSelector');

    strengthsDiv.innerHTML = '';
    improvementsDiv.innerHTML = '';

    tenets.forEach(tenet => {
        // Strength selector
        const strengthItem = document.createElement('div');
        strengthItem.className = 'tenet-item';
        if (selectedStrengths.includes(tenet.id)) {
            strengthItem.classList.add('selected-strength');
        }
        // Disable if already selected as improvement
        if (selectedImprovements.includes(tenet.id)) {
            strengthItem.classList.add('disabled');
        }
        strengthItem.innerHTML = `
            <div class="tenet-name">${tenet.name}</div>
            <div class="tenet-description">${tenet.description}</div>
        `;
        strengthItem.onclick = () => toggleStrength(tenet.id);
        strengthsDiv.appendChild(strengthItem);

        // Improvement selector
        const improvementItem = document.createElement('div');
        improvementItem.className = 'tenet-item';
        if (selectedImprovements.includes(tenet.id)) {
            improvementItem.classList.add('selected-improvement');
        }
        // Disable if already selected as strength
        if (selectedStrengths.includes(tenet.id)) {
            improvementItem.classList.add('disabled');
        }
        improvementItem.innerHTML = `
            <div class="tenet-name">${tenet.name}</div>
            <div class="tenet-description">${tenet.description}</div>
        `;
        improvementItem.onclick = () => toggleImprovement(tenet.id);
        improvementsDiv.appendChild(improvementItem);
    });
}

function toggleStrength(tenetId) {
    const index = selectedStrengths.indexOf(tenetId);
    if (index > -1) {
        selectedStrengths.splice(index, 1);
    } else {
        // Check if already selected as improvement
        if (selectedImprovements.includes(tenetId)) {
            // Don't allow selecting same tenet for both
            return;
        }
        if (selectedStrengths.length < 3) {
            selectedStrengths.push(tenetId);
        } else {
            // Don't show alert, just don't add it
            return;
        }
    }
    renderTenets();
    validateFeedback(); // Update inline errors
    scheduleAutoSave();
}

function toggleImprovement(tenetId) {
    const index = selectedImprovements.indexOf(tenetId);
    if (index > -1) {
        selectedImprovements.splice(index, 1);
    } else {
        // Check if already selected as strength
        if (selectedStrengths.includes(tenetId)) {
            // Don't allow selecting same tenet for both
            return;
        }
        if (selectedImprovements.length < 3) {
            selectedImprovements.push(tenetId);
        } else {
            // Don't show alert, just don't add it
            return;
        }
    }
    renderTenets();
    validateFeedback(); // Update inline errors
    scheduleAutoSave();
}

function selectColleague() {
    const userId = document.getElementById('colleagueSelect').value;
    if (!userId) {
        document.getElementById('feedbackForm').style.display = 'none';
        return;
    }

    selectedColleague = userId;

    // Load existing feedback if any
    const existing = existingFeedback.find(f => f.to_user_id === userId);
    if (existing) {
        selectedStrengths = existing.strengths;
        selectedImprovements = existing.improvements;
        document.getElementById('strengthsText').value = existing.strengths_text || '';
        document.getElementById('improvementsText').value = existing.improvements_text || '';
    } else {
        selectedStrengths = [];
        selectedImprovements = [];
        document.getElementById('strengthsText').value = '';
        document.getElementById('improvementsText').value = '';
    }

    renderTenets();
    updateChecklist(); // Initialize checklist
    document.getElementById('feedbackForm').style.display = 'block';

    // Add auto-save listeners to textareas
    document.getElementById('strengthsText').addEventListener('input', scheduleAutoSave);
    document.getElementById('improvementsText').addEventListener('input', scheduleAutoSave);
}

function scheduleAutoSave() {
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }

    autoSaveTimer = setTimeout(() => {
        saveFeedback();
    }, 2000);
}

function saveFeedback() {
    if (!selectedColleague) {
        return;
    }

    // Only save if we have valid selections
    if (selectedStrengths.length !== 3) {
        return;
    }

    if (selectedImprovements.length < 2 || selectedImprovements.length > 3) {
        return;
    }

    const data = {
        to_user_id: selectedColleague,
        strengths: selectedStrengths,
        improvements: selectedImprovements,
        strengths_text: document.getElementById('strengthsText').value,
        improvements_text: document.getElementById('improvementsText').value
    };

    fetch('/api/feedback', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showSaveIndicator();
            updateFeedbackList();
        }
    })
    .catch(err => {
        console.error('Auto-save error:', err);
    });
}

function updateColleagueDropdownIndicators() {
    // Update the checkmarks/circles in the colleague dropdown
    const select = document.getElementById('colleagueSelect');
    const options = select.querySelectorAll('option[value]');

    options.forEach(option => {
        const userId = option.value;
        if (!userId) return; // Skip the placeholder option

        const hasFeedback = existingFeedback.some(f => f.to_user_id === userId);
        const text = option.textContent;

        // Remove any existing indicator
        const cleanText = text.replace(/^[âœ“â—‹]\s/, '');

        // Add appropriate indicator
        option.textContent = (hasFeedback ? 'âœ“' : 'â—‹') + ' ' + cleanText;
    });
}

function updateFeedbackList() {
    // Update the existing feedback entry in the list without full page reload
    const existing = existingFeedback.find(f => f.to_user_id === selectedColleague);

    if (existing) {
        // Update existing entry
        existing.strengths = selectedStrengths;
        existing.improvements = selectedImprovements;
        existing.strengths_text = document.getElementById('strengthsText').value;
        existing.improvements_text = document.getElementById('improvementsText').value;
    } else {
        // Add new entry
        existingFeedback.push({
            to_user_id: selectedColleague,
            strengths: selectedStrengths,
            improvements: selectedImprovements,
            strengths_text: document.getElementById('strengthsText').value,
            improvements_text: document.getElementById('improvementsText').value
        });
    }

    renderFeedbackList();
    updateColleagueDropdownIndicators();
}

function renderFeedbackList() {
    const listDiv = document.getElementById('feedbackList');

    if (existingFeedback.length === 0) {
        listDiv.innerHTML = '<p style="color: #999;">No feedback submitted yet.</p>';
        return;
    }

    listDiv.innerHTML = existingFeedback.map((fb, index) => {
        const person = allPeople.find(p => p.user_id === fb.to_user_id);
        const personName = person ? person.name : fb.to_user_id;

        // Get tenet names
        const strengthTenets = fb.strengths.map(id => {
            const tenet = tenets.find(t => t.id === id);
            return tenet ? tenet.name : id;
        });

        const improvementTenets = fb.improvements.map(id => {
            const tenet = tenets.find(t => t.id === id);
            return tenet ? tenet.name : id;
        });

        return `
            <div class="feedback-item" id="feedback-item-${index}">
                <div class="feedback-item-header" onclick="toggleFeedbackItem(${index})">
                    <div class="feedback-item-name">
                        ${personName}
                        <span class="feedback-item-summary">${fb.strengths.length} strengths, ${fb.improvements.length} improvements</span>
                    </div>
                    <div class="feedback-item-actions" onclick="event.stopPropagation()">
                        <button onclick="copyFeedbackForWorkday(${index})" class="btn" style="padding: 6px 12px;" title="Copy formatted feedback to clipboard">ðŸ“‹ Copy</button>
                        <button onclick="editFeedback('${fb.to_user_id}')" class="btn btn-secondary" style="padding: 6px 12px;">Edit</button>
                        <button onclick="deleteFeedback('${fb.to_user_id}')" class="btn btn-danger" style="padding: 6px 12px;">Delete</button>
                    </div>
                </div>
                <div class="feedback-item-body">
                    <div class="feedback-tenets" style="margin-top: 12px;">
                        <div class="tenet-group strengths">
                            <div class="tenet-group-title">Strengths (${fb.strengths.length})</div>
                            <ul class="tenet-list strengths">
                                ${strengthTenets.map(name => `<li>${name}</li>`).join('')}
                            </ul>
                            ${fb.strengths_text ? `<div style="margin-top: 8px; font-size: 13px; color: #495057; font-style: italic;">${fb.strengths_text}</div>` : ''}
                        </div>
                        <div class="tenet-group improvements">
                            <div class="tenet-group-title">Improvements (${fb.improvements.length})</div>
                            <ul class="tenet-list improvements">
                                ${improvementTenets.map(name => `<li>${name}</li>`).join('')}
                            </ul>
                            ${fb.improvements_text ? `<div style="margin-top: 8px; font-size: 13px; color: #495057; font-style: italic;">${fb.improvements_text}</div>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function toggleFeedbackItem(index) {
    const item = document.getElementById(`feedback-item-${index}`);
    item.classList.toggle('expanded');
}

function copyFeedbackForWorkday(index) {
    const fb = existingFeedback[index];
    const formatted = formatFeedbackForWorkday(fb);

    navigator.clipboard.writeText(formatted).then(() => {
        // Show brief confirmation on the button
        const item = document.getElementById(`feedback-item-${index}`);
        const copyBtn = item.querySelector('.feedback-item-actions button:first-child');
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = 'âœ“ Copied!';
        copyBtn.style.background = '#28a745';
        copyBtn.style.color = 'white';
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.style.background = '';
            copyBtn.style.color = '';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard. Please try again.');
    });
}

function showSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

function updateChecklist() {
    const strengthsDone = selectedStrengths.length === 3;
    const improvementsDone = selectedImprovements.length >= 2 && selectedImprovements.length <= 3;
    const allDone = strengthsDone && improvementsDone;

    // Update strengths checklist item
    const strengthsItem = document.getElementById('checkStrengths');
    strengthsItem.textContent = `Select 3 strengths (${selectedStrengths.length}/3)`;
    if (strengthsDone) {
        strengthsItem.classList.add('done');
    } else {
        strengthsItem.classList.remove('done');
    }

    // Update improvements checklist item
    const improvementsItem = document.getElementById('checkImprovements');
    if (selectedImprovements.length > 3) {
        improvementsItem.textContent = `Select 2-3 improvements (${selectedImprovements.length}/3 - deselect ${selectedImprovements.length - 3})`;
        improvementsItem.classList.remove('done');
    } else {
        improvementsItem.textContent = `Select 2-3 improvements (${selectedImprovements.length}/3)`;
        if (improvementsDone) {
            improvementsItem.classList.add('done');
        } else {
            improvementsItem.classList.remove('done');
        }
    }

    // Update checklist box color
    const checklistBox = document.getElementById('feedbackChecklist');
    const checklistTitle = document.getElementById('checklistTitle');

    if (allDone) {
        checklistBox.classList.add('complete');
        checklistTitle.textContent = 'âœ“ Ready to save (auto-saves in 2 seconds)';
    } else {
        checklistBox.classList.remove('complete');
        checklistTitle.textContent = 'Feedback Progress:';
    }

    return allDone;
}

function validateFeedback() {
    return updateChecklist();
}

function cancelFeedback() {
    // Check if there's any data entered
    const hasAnyData = selectedStrengths.length > 0 ||
                       selectedImprovements.length > 0 ||
                       document.getElementById('strengthsText').value.trim() !== '' ||
                       document.getElementById('improvementsText').value.trim() !== '';

    // If there's data, validate it
    if (hasAnyData) {
        const isValid = updateChecklist();
        if (!isValid) {
            // Keep form open, checklist shows what's missing
            return;
        }
    }

    // Either no data or valid - close the form
    document.getElementById('colleagueSelect').value = '';
    document.getElementById('feedbackForm').style.display = 'none';
    selectedColleague = null;
    selectedStrengths = [];
    selectedImprovements = [];

    // Scroll to top of feedback list
    document.querySelector('.feedback-list').scrollIntoView({ behavior: 'smooth' });
}

function editFeedback(userId) {
    document.getElementById('colleagueSelect').value = userId;
    selectColleague();
}

function deleteFeedback(userId) {
    if (!confirm('Are you sure you want to delete this feedback?')) {
        return;
    }

    fetch(`/api/feedback/${userId}`, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Remove from local array
            const index = existingFeedback.findIndex(f => f.to_user_id === userId);
            if (index > -1) {
                existingFeedback.splice(index, 1);
            }
            renderFeedbackList();
            updateColleagueDropdownIndicators();
        }
    });
}

// Initialize feedback list rendering on page load
if (existingFeedback.length > 0) {
    renderFeedbackList();
    updateColleagueDropdownIndicators();
}

// Workday copy functionality
function formatFeedbackForWorkday(feedback) {
    // Get tenet names
    const strengthTenets = feedback.strengths.map(id => {
        const tenet = tenets.find(t => t.id === id);
        return tenet ? tenet.name : id;
    });

    const improvementTenets = feedback.improvements.map(id => {
        const tenet = tenets.find(t => t.id === id);
        return tenet ? tenet.name : id;
    });

    // Build the formatted text with human-readable content first, machine-parseable marker at bottom
    let text = `Strengths:
${strengthTenets.map(name => 'â€¢ ' + name).join('\n')}
${feedback.strengths_text ? '\n' + feedback.strengths_text : ''}

Areas for Improvement:
${improvementTenets.map(name => 'â€¢ ' + name).join('\n')}
${feedback.improvements_text ? '\n' + feedback.improvements_text : ''}

[TENETS]
Strengths: ${feedback.strengths.join(', ')}
Improvements: ${feedback.improvements.join(', ')}
[/TENETS]`;

    return text;
}

</script>
{% endblock %}
