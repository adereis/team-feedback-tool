{% extends "base.html" %}

{% block title %}Export Feedback{% endblock %}
{% block header %}Export Feedback{% endblock %}

{% block extra_styles %}
<style>
    th.sortable {
        cursor: pointer;
        user-select: none;
    }

    th.sortable:hover {
        background: #f0f0f0;
    }

    th.sortable::after {
        content: ' ↕';
        color: #999;
        font-size: 12px;
    }

    th.sortable.asc::after {
        content: ' ↑';
        color: #667eea;
    }

    th.sortable.desc::after {
        content: ' ↓';
        color: #667eea;
    }

    .associates-list {
        font-size: 13px;
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <a href="/individual" class="btn btn-secondary" style="margin-bottom: 16px;">← Back to Feedback</a>

    <h2>Download Feedback CSVs</h2>
    <p style="margin-bottom: 20px;">
        Click to download a CSV file for each manager. Share each file with the respective manager.
    </p>

    <table id="exportTable">
        <thead>
            <tr>
                <th class="sortable" onclick="sortTable(0)">Manager</th>
                <th class="sortable" onclick="sortTable(1)">Associates</th>
                <th class="sortable" onclick="sortTable(2)">Feedback Count</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in export_list %}
            <tr data-manager="{{ item.manager_name }}" data-associates="{{ item.associates|length }}" data-count="{{ item.feedback_count }}">
                <td><strong>{{ item.manager_name }}</strong> ({{ item.manager_uid }})</td>
                <td class="associates-list">{{ item.associates|join(', ') }}</td>
                <td>{{ item.feedback_count }} feedback(s)</td>
                <td>
                    <a href="/individual/export/{{ item.manager_uid }}" class="btn" style="padding: 6px 16px;">
                        Download CSV
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSort = { column: -1, direction: 'asc' };

function sortTable(columnIndex) {
    const table = document.getElementById('exportTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const headers = table.querySelectorAll('th.sortable');

    // Determine sort direction
    if (currentSort.column === columnIndex) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = columnIndex;
        currentSort.direction = 'asc';
    }

    // Update header indicators
    headers.forEach((header, index) => {
        header.classList.remove('asc', 'desc');
        if (index === columnIndex) {
            header.classList.add(currentSort.direction);
        }
    });

    // Get data attribute for sorting
    const dataAttr = ['data-manager', 'data-associates', 'data-count'][columnIndex];

    // Sort rows
    rows.sort((a, b) => {
        let aVal = a.getAttribute(dataAttr);
        let bVal = b.getAttribute(dataAttr);

        // Convert to numbers for count column
        if (columnIndex === 2 || columnIndex === 1) {
            aVal = parseInt(aVal);
            bVal = parseInt(bVal);
        } else {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
    });

    // Re-append rows in sorted order
    rows.forEach(row => tbody.appendChild(row));
}

// Default sort by manager name
sortTable(0);
</script>
{% endblock %}
