{% extends "base.html" %}

{% block title %}Feedback Report - {{ team_member.name }}{% endblock %}
{% block header %}Feedback Report{% endblock %}

{% block extra_styles %}
<style>
    .feedback-checklist {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 12px 16px;
        margin-bottom: 16px;
        border-radius: 4px;
        color: #856404;
        font-size: 13px;
        transition: all 0.3s;
    }

    .feedback-checklist.complete {
        background: #d4edda;
        border-left-color: #28a745;
        color: #155724;
    }

    .feedback-checklist strong {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .feedback-checklist ul {
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .feedback-checklist li {
        margin: 4px 0;
        padding-left: 20px;
        position: relative;
    }

    .feedback-checklist li::before {
        content: '‚óã';
        position: absolute;
        left: 0;
        color: #ffc107;
        font-weight: bold;
    }

    .feedback-checklist li.done::before {
        content: '‚úì';
        color: #28a745;
    }

    .feedback-checklist.complete li::before {
        content: '‚úì';
        color: #28a745;
    }

    .tenet-name {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .tenet-description {
        font-size: 12px;
        color: #666;
    }

    .feedback-text-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
    }

    .save-indicator {
        display: inline-block;
        margin-left: 12px;
        color: #28a745;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .save-indicator.show {
        opacity: 1;
    }

    .manager-context {
        background: #e7f3ff;
        border-left: 4px solid #2196F3;
        padding: 12px 16px;
        margin-bottom: 20px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .manager-context strong {
        color: #1976D2;
        font-size: 15px;
    }

    .manager-context a {
        color: #667eea;
        text-decoration: none;
        font-size: 13px;
    }

    .manager-context a:hover {
        text-decoration: underline;
    }

    .copy-section {
        background: #f0f9ff;
        border: 1px solid #b3d9ff;
        border-radius: 8px;
        padding: 20px;
        margin-top: 24px;
    }

    .copy-section h4 {
        margin: 0 0 12px 0;
        color: #0066cc;
        font-size: 15px;
    }

    .copy-preview {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 12px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 12px;
    }

    .copy-btn {
        background: #0066cc;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .copy-btn:hover {
        background: #0052a3;
    }

    .copy-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .copy-success {
        color: #28a745;
        font-weight: 600;
        margin-left: 12px;
        display: none;
    }

    .copy-success.visible {
        display: inline;
    }
</style>
{% endblock %}

{% block content %}
<div class="manager-context">
    <div>
        <strong>Feedback report for:</strong> {{ team_member.name }}
    </div>
    <a href="{% if demo_mode %}/demo{% endif %}/manager">‚Üê Back to Dashboard</a>
</div>

<div class="card">

    <h2>{{ team_member.name }}</h2>
    <p style="color: #666; margin-bottom: 20px;">
        {{ team_member.job_title }} | {{ team_member.email }}
    </p>

    <div class="info-box">
        <strong>{{ feedbacks|length }} structured feedback(s)</strong>
        {% if generic_feedbacks|length > 0 %}
        <span style="margin-left: 12px; color: #856404;">+ {{ generic_feedbacks|length }} additional from Workday</span>
        {% endif %}
    </div>
</div>

<div class="card">
    <h2>Team Tenets - Butterfly Chart</h2>
    <p style="margin-bottom: 12px; color: #666;">
        Aggregated feedback from all peers. Strengths shown in green (right), improvements in red (left).
    </p>
    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px 14px; margin-bottom: 20px; border-radius: 4px; font-size: 13px;">
        <strong>Legend:</strong> Manager-selected tenets have brighter colors and thicker colored borders
        (green border = strength, red border = improvement).
        Bar lengths include both peer feedback AND manager selection (each counts as +1).
    </div>
    <div id="butterflyChart"></div>
</div>

<div class="card">
    <h2>Peer Feedback Comments</h2>
    <p style="color: #666; font-size: 13px; margin-bottom: 16px;">
        Structured feedback from peers (with tenet selections).
    </p>

    <h3>Strengths</h3>
    {% if feedbacks|length == 0 %}
    <p style="color: #999;">No structured feedback received yet.</p>
    {% else %}
    {% for fb in feedbacks %}
    {% if fb.strengths_text %}
    <div class="feedback-text-item">
        <div style="font-weight: 600; color: #667eea; margin-bottom: 6px; font-size: 13px;">
            From: {{ fb.from_name }}
            {% if fb.source == 'workday_structured' %}
            <span style="background: #e7f3ff; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px;">Workday</span>
            {% endif %}
        </div>
        {{ fb.strengths_text }}
    </div>
    {% endif %}
    {% endfor %}
    {% endif %}

    <h3 style="margin-top: 24px;">Areas for Improvement</h3>
    {% for fb in feedbacks %}
    {% if fb.improvements_text %}
    <div class="feedback-text-item">
        <div style="font-weight: 600; color: #667eea; margin-bottom: 6px; font-size: 13px;">
            From: {{ fb.from_name }}
            {% if fb.source == 'workday_structured' %}
            <span style="background: #e7f3ff; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px;">Workday</span>
            {% endif %}
        </div>
        {{ fb.improvements_text }}
    </div>
    {% endif %}
    {% endfor %}
</div>

{% if generic_feedbacks|length > 0 %}
<div class="card">
    <h2>Additional Feedback from Workday</h2>
    <p style="color: #666; font-size: 13px; margin-bottom: 16px;">
        Generic feedback from Workday (free-text, not included in butterfly chart).
    </p>

    {% for fb in generic_feedbacks %}
    <div class="feedback-text-item" style="border-left-color: #ffc107;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div style="font-weight: 600; color: #856404; font-size: 13px;">From: {{ fb.from_name }}</div>
            <div style="font-size: 11px; color: #999;">
                {% if fb.date %}{{ fb.date[:10] }}{% endif %}
            </div>
        </div>
        {% if fb.question %}
        <div style="font-style: italic; color: #666; font-size: 12px; margin-bottom: 8px;">
            Q: {{ fb.question[:100] }}{% if fb.question|length > 100 %}...{% endif %}
        </div>
        {% endif %}
        <div>{{ fb.feedback }}</div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="card">
    <h2>Your Feedback (Manager)</h2>
    <p style="margin-bottom: 16px; color: #666;">
        Select tenets to highlight in the report and add your own feedback text.
    </p>

    <div id="feedbackChecklist" class="feedback-checklist">
        <strong id="checklistTitle">Selection Progress:</strong>
        <ul>
            <li id="checkStrengths">Select 3 strengths (0/3)</li>
            <li id="checkImprovements">Select 2-3 improvements (0/3)</li>
        </ul>
    </div>

    <h3>Select Strengths to Highlight</h3>
    <div id="managerStrengthsSelector" class="tenet-selector"></div>

    <h3>Select Improvements to Highlight</h3>
    <div id="managerImprovementsSelector" class="tenet-selector"></div>

    <div class="form-group">
        <label>Your Feedback Text</label>
        <textarea id="managerFeedbackText" placeholder="Write your feedback for this team member...">{{ manager_feedback.feedback_text if manager_feedback else '' }}</textarea>
        <span id="saveIndicator" class="save-indicator">‚úì Saved</span>
    </div>

    <!-- Copy for Workday Section -->
    <div class="copy-section">
        <h4>Copy for Workday</h4>
        <p style="margin-bottom: 12px; color: #666; font-size: 14px;">
            Copy your manager feedback (tenet selections + text) to paste into Workday.
        </p>
        <div class="copy-preview" id="managerCopyPreview">
            <em style="color: #999;">Complete 3 strengths and 2-3 improvements to see preview...</em>
        </div>
        <button class="copy-btn" id="managerCopyBtn" onclick="copyManagerFeedback()" disabled>Copy to Clipboard</button>
        <span class="copy-success" id="managerCopySuccess">‚úì Copied!</span>
    </div>
</div>

<div class="card">
    <h2>Export Report</h2>
    <p style="margin-bottom: 16px;">
        Generate a PDF report with the butterfly chart and all feedback. This report is intended for the team member,
        so peer feedback will be <strong>anonymous</strong> (names removed), while your manager feedback will be attributed.
    </p>
    <button onclick="exportPDF()" class="btn">üìÑ Export PDF Report</button>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
const butterflyData = {{ butterfly_data | tojson | safe }};
const tenets = {{ tenets | tojson | safe }};
const teamMemberId = "{{ team_member.user_id }}";

let managerSelectedStrengths = {{ (manager_feedback.selected_strengths if manager_feedback else []) | tojson | safe }};
let managerSelectedImprovements = {{ (manager_feedback.selected_improvements if manager_feedback else []) | tojson | safe }};

// Render butterfly chart
function renderButterflyChart() {
    const container = document.getElementById('butterflyChart');
    container.innerHTML = '';

    // Check if we have data
    if (!butterflyData || butterflyData.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No feedback data available yet.</p>';
        return;
    }

    // Calculate max value, ensure minimum of 1 for proper scaling
    const maxValue = Math.max(
        1,  // Minimum value to prevent chart issues
        ...butterflyData.map(t => Math.max(t.strength_count, t.improvement_count))
    );

    butterflyData.forEach((tenet, index) => {
        const row = document.createElement('div');
        row.style.cssText = 'display: grid; grid-template-columns: 1fr 300px 1fr; gap: 8px; align-items: center; margin-bottom: 4px; padding: 2px 0;';

        // Left - Improvements (red)
        const improvementDiv = document.createElement('div');
        improvementDiv.style.cssText = 'text-align: right;';
        const improvementCanvas = document.createElement('canvas');
        improvementCanvas.id = `improvement-${index}`;
        improvementCanvas.height = 25;
        improvementDiv.appendChild(improvementCanvas);

        // Center - Tenet name
        const labelDiv = document.createElement('div');
        labelDiv.style.cssText = 'font-weight: 600; color: #2c3e50; padding: 0 10px; text-align: center; overflow: hidden; text-overflow: ellipsis; font-size: 14px;';

        // Check if manager selected (but don't highlight the label - highlighting is on the bars)
        const isStrengthSelected = managerSelectedStrengths.includes(tenet.id);
        const isImprovementSelected = managerSelectedImprovements.includes(tenet.id);

        labelDiv.textContent = tenet.name;

        // Right - Strengths (green)
        const strengthDiv = document.createElement('div');
        strengthDiv.style.cssText = 'text-align: left;';
        const strengthCanvas = document.createElement('canvas');
        strengthCanvas.id = `strength-${index}`;
        strengthCanvas.height = 25;
        strengthDiv.appendChild(strengthCanvas);

        row.appendChild(improvementDiv);
        row.appendChild(labelDiv);
        row.appendChild(strengthDiv);
        container.appendChild(row);

        // Create charts
        new Chart(improvementCanvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [{
                    data: [tenet.improvement_count],
                    backgroundColor: isImprovementSelected ? '#ff6b6b' : '#dc3545',
                    borderColor: isImprovementSelected ? '#ff0000' : 'black',
                    borderWidth: isImprovementSelected ? 2.5 : 0.5
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Improvements: ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: maxValue,
                        reverse: true,
                        display: false,
                        grid: { display: false },
                        ticks: { display: false }
                    },
                    y: {
                        display: false,
                        grid: { display: false }
                    }
                }
            }
        });

        new Chart(strengthCanvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [{
                    data: [tenet.strength_count],
                    backgroundColor: isStrengthSelected ? '#51cf66' : '#28a745',
                    borderColor: isStrengthSelected ? '#00ff00' : 'black',
                    borderWidth: isStrengthSelected ? 2.5 : 0.5
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Strengths: ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: maxValue,
                        display: false,
                        grid: { display: false },
                        ticks: { display: false }
                    },
                    y: {
                        display: false,
                        grid: { display: false }
                    }
                }
            }
        });
    });
}

// Render manager tenet selectors
function renderManagerTenetSelectors() {
    const strengthsDiv = document.getElementById('managerStrengthsSelector');
    const improvementsDiv = document.getElementById('managerImprovementsSelector');

    strengthsDiv.innerHTML = '';
    improvementsDiv.innerHTML = '';

    tenets.forEach(tenet => {
        // Strength selector
        const strengthItem = document.createElement('div');
        strengthItem.className = 'tenet-item';
        if (managerSelectedStrengths.includes(tenet.id)) {
            strengthItem.classList.add('selected-strength');
        }
        // Disable if already selected as improvement
        if (managerSelectedImprovements.includes(tenet.id)) {
            strengthItem.classList.add('disabled');
        }
        strengthItem.innerHTML = `
            <div class="tenet-name">${tenet.name}</div>
            <div class="tenet-description" style="font-size: 12px; color: #666;">${tenet.description}</div>
        `;
        strengthItem.onclick = () => toggleManagerStrength(tenet.id);
        strengthsDiv.appendChild(strengthItem);

        // Improvement selector
        const improvementItem = document.createElement('div');
        improvementItem.className = 'tenet-item';
        if (managerSelectedImprovements.includes(tenet.id)) {
            improvementItem.classList.add('selected-improvement');
        }
        // Disable if already selected as strength
        if (managerSelectedStrengths.includes(tenet.id)) {
            improvementItem.classList.add('disabled');
        }
        improvementItem.innerHTML = `
            <div class="tenet-name">${tenet.name}</div>
            <div class="tenet-description" style="font-size: 12px; color: #666;">${tenet.description}</div>
        `;
        improvementItem.onclick = () => toggleManagerImprovement(tenet.id);
        improvementsDiv.appendChild(improvementItem);
    });
}

function toggleManagerStrength(tenetId) {
    const index = managerSelectedStrengths.indexOf(tenetId);
    if (index > -1) {
        managerSelectedStrengths.splice(index, 1);
    } else {
        // Don't allow selecting if already selected as improvement
        if (managerSelectedImprovements.includes(tenetId)) {
            return;
        }
        // Enforce exactly 3 strengths limit
        if (managerSelectedStrengths.length >= 3) {
            return;
        }
        managerSelectedStrengths.push(tenetId);
    }
    renderManagerTenetSelectors();
    renderButterflyChart();
    updateChecklist();
    updateManagerCopyPreview();
    scheduleAutoSave();
}

function toggleManagerImprovement(tenetId) {
    const index = managerSelectedImprovements.indexOf(tenetId);
    if (index > -1) {
        managerSelectedImprovements.splice(index, 1);
    } else {
        // Don't allow selecting if already selected as strength
        if (managerSelectedStrengths.includes(tenetId)) {
            return;
        }
        // Enforce 2-3 improvements limit
        if (managerSelectedImprovements.length >= 3) {
            return;
        }
        managerSelectedImprovements.push(tenetId);
    }
    renderManagerTenetSelectors();
    renderButterflyChart();
    updateChecklist();
    updateManagerCopyPreview();
    scheduleAutoSave();
}

// Collect manager feedback data for saving
function collectManagerFeedbackData() {
    return {
        team_member_uid: teamMemberId,
        selected_strengths: managerSelectedStrengths,
        selected_improvements: managerSelectedImprovements,
        feedback_text: document.getElementById('managerFeedbackText').value
    };
}

// Check if manager feedback is valid for saving
function isManagerFeedbackValid() {
    if (managerSelectedStrengths.length !== 3) return false;
    if (managerSelectedImprovements.length < 2 || managerSelectedImprovements.length > 3) return false;
    return true;
}

function scheduleAutoSave() {
    if (!isManagerFeedbackValid()) return;

    // Use global AutoSave manager - handles debounce and keepalive on unload
    window.AutoSave.debounce(
        `manager_feedback_${teamMemberId}`,
        API_PREFIX + '/manager-feedback',
        collectManagerFeedbackData,
        2000
    );
}

function showSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

function updateChecklist() {
    const strengthsDone = managerSelectedStrengths.length === 3;
    const improvementsDone = managerSelectedImprovements.length >= 2 && managerSelectedImprovements.length <= 3;
    const allDone = strengthsDone && improvementsDone;

    // Update strengths checklist item
    const strengthsItem = document.getElementById('checkStrengths');
    strengthsItem.textContent = `Select 3 strengths (${managerSelectedStrengths.length}/3)`;
    if (strengthsDone) {
        strengthsItem.classList.add('done');
    } else {
        strengthsItem.classList.remove('done');
    }

    // Update improvements checklist item
    const improvementsItem = document.getElementById('checkImprovements');
    improvementsItem.textContent = `Select 2-3 improvements (${managerSelectedImprovements.length}/3)`;
    if (improvementsDone) {
        improvementsItem.classList.add('done');
    } else {
        improvementsItem.classList.remove('done');
    }

    // Update checklist box color
    const checklistBox = document.getElementById('feedbackChecklist');
    const checklistTitle = document.getElementById('checklistTitle');

    if (allDone) {
        checklistBox.classList.add('complete');
        checklistTitle.textContent = '‚úì Ready to save (auto-saves in 2 seconds)';
    } else {
        checklistBox.classList.remove('complete');
        checklistTitle.textContent = 'Selection Progress:';
    }

    return allDone;
}

function saveManagerFeedback() {
    // Only save if requirements are met
    if (managerSelectedStrengths.length !== 3) {
        return;
    }
    if (managerSelectedImprovements.length < 2 || managerSelectedImprovements.length > 3) {
        return;
    }

    const data = {
        team_member_uid: teamMemberId,
        selected_strengths: managerSelectedStrengths,
        selected_improvements: managerSelectedImprovements,
        feedback_text: document.getElementById('managerFeedbackText').value
    };

    fetch(API_PREFIX + '/manager-feedback', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showSaveIndicator();
        } else {
            console.error('Error saving manager feedback:', data.error);
        }
    })
    .catch(error => {
        console.error('Error saving manager feedback:', error);
    });
}

function exportPDF() {
    // Trigger download by navigating to PDF export endpoint
    const baseUrl = IS_DEMO_MODE ? '/demo/manager/export-pdf/' : '/manager/export-pdf/';
    window.location.href = baseUrl + teamMemberId;
}

function updateManagerCopyPreview() {
    const previewEl = document.getElementById('managerCopyPreview');
    const copyBtn = document.getElementById('managerCopyBtn');

    // Check if manager feedback is complete
    const strengthsDone = managerSelectedStrengths.length === 3;
    const improvementsDone = managerSelectedImprovements.length >= 2 && managerSelectedImprovements.length <= 3;
    const isComplete = strengthsDone && improvementsDone;

    if (!isComplete) {
        previewEl.innerHTML = '<em style="color: #999;">Complete 3 strengths and 2-3 improvements to see preview...</em>';
        copyBtn.disabled = true;
        return;
    }

    copyBtn.disabled = false;

    // Get tenet names
    const strengthNames = managerSelectedStrengths.map(id => {
        const t = tenets.find(t => t.id === id);
        return t ? t.name : id;
    });
    const improvementNames = managerSelectedImprovements.map(id => {
        const t = tenets.find(t => t.id === id);
        return t ? t.name : id;
    });

    const feedbackText = document.getElementById('managerFeedbackText').value.trim();

    // Build formatted output - human-readable first, machine-parseable marker at bottom
    let output = `Strengths:
${strengthNames.map(n => '‚Ä¢ ' + n).join('\n')}

Areas for Improvement:
${improvementNames.map(n => '‚Ä¢ ' + n).join('\n')}
`;

    if (feedbackText) {
        output += `
Manager's Feedback:
${feedbackText}
`;
    }

    // Add machine-parseable marker at the end
    output += `
[TENETS]
Strengths: ${managerSelectedStrengths.join(', ')}
Improvements: ${managerSelectedImprovements.join(', ')}
[/TENETS]`;

    previewEl.textContent = output;
}

function copyManagerFeedback() {
    const previewEl = document.getElementById('managerCopyPreview');
    const text = previewEl.textContent;

    navigator.clipboard.writeText(text).then(() => {
        const successEl = document.getElementById('managerCopySuccess');
        successEl.classList.add('visible');
        setTimeout(() => {
            successEl.classList.remove('visible');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        // Fallback: select text
        const range = document.createRange();
        range.selectNode(previewEl);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
    });
}

// Initialize
try {
    console.log('Butterfly data:', butterflyData);
    console.log('Tenets:', tenets);
    renderButterflyChart();
    renderManagerTenetSelectors();
    updateChecklist();
    updateManagerCopyPreview();
} catch (error) {
    console.error('Error initializing charts:', error);
    document.getElementById('butterflyChart').innerHTML =
        '<p style="color: #dc3545; padding: 20px;">Error loading chart: ' + error.message + '</p>';
}

// Add auto-save and preview update to feedback text
const feedbackTextArea = document.getElementById('managerFeedbackText');
feedbackTextArea.addEventListener('input', () => {
    scheduleAutoSave();
    updateManagerCopyPreview();
});
</script>
{% endblock %}
